name: 1.0$(rev:.r) # build numbering format

resources:
- repo: self
phases:
- phase: Phase_1
  displayName: Agent job 1

  condition: succeeded()
  queue:
    name: Hosted VS2017
    demands: 
   - msbuild
   - visualstudio
   - vstest

  variables:
    ProductName: 'DEFIME'
    ProductDescription: 'DEFINE'
  steps:
  - task: NuGetToolInstaller@0
    displayName: 'Use NuGet 4.4.1'
    inputs:
      versionSpec: 4.4.1


  - task: NuGetCommand@2
    displayName: Restore
    inputs:
      vstsFeed: '3c2d9c9a-d8f7-42f4-b7a3-dddf4064110a'


  - task: sebastianlux.UpdateAssemblyInfo.UpdateAssemblyInfo-task.Update AssemblyInfo@1
    displayName: 'Update AssemblyInfo.cs files: $(Build.SourcesDirectory)'
    inputs:
      assemblyProduct: '$(ProductName)'

      assemblyDescription: '$(ProductDescription)'

      assemblyVersion: '$(Build.BuildNumber)'

      assemblyFileVersion: '$(Build.BuildNumber)'

      assemblyInformationalVersion: '$(Build.BuildNumber)'


  - task: VSBuild@1
    displayName: 'Build solution **\*.sln'
    inputs:
      msbuildArgs: '/p:TreatWarningsAsErrors="true"'

      platform: '$(BuildPlatform)'

      configuration: '$(BuildConfiguration)'


  - task: VSTest@2
    displayName: 'VsTest - testAssemblies'
    inputs:
      testAssemblyVer2: |  
       **\$(BuildConfiguration)\*test*.dll
       !**\obj\**


  - task: PublishSymbols@2
    displayName: 'Publish symbols path'
    inputs:
      PublishSymbols: false


  - task: NuGetCommand@2
    displayName: Pack
    inputs:
      command: pack

      packagesToPack: 'Sources/Application/*.csproj'

      versioningScheme: byBuildNumber


  - task: NuGetCommand@2
    displayName: Push
    inputs:
      command: push

      publishVstsFeed: '3c2d9c9a-d8f7-42f4-b7a3-dddf4064110a'

      allowPackageConflicts: true



- phase: Phase_2
  displayName: Create Release Work Item

  dependsOn: Phase_1
  condition: succeeded()
  server: true
  variables:
    ParentWorkItemId: 'DEFINE'
  steps:
  - task: AzureFunction@1
    displayName: 'Create Release Work Item'
    inputs:
      function: 'https://tfsreleasemanagementsystem.azurewebsites.net/api/CreateRelease'

      key: 'KCw8zHoDdJ2lGj2VzaHCaywIVZTGyT8MldAkAlcdFb63V9ephxuA1A=='

      headers: |  
       {
       "Content-Type":"application/json"
       }

      body: |  
       {
           "buildId": $(Build.BuildId),
           "buildVersion": "$(Build.BuildNumber)",
           "parentWorkItemId": $(ParentWorkItemId)
       }


